{% extends "core/base.html" %}

{% load humanize %}

{% block title %}SIGEC | Balance Consolidado{% endblock %}

{% block header %}
<div style="display: flex; justify-content: space-between; align-items: center;">
    <div>
        <h2>Balance Consolidado</h2>
        <p>
            Visualiza el balance general consolidado de todas las sub-empresas
            {% if empresa_actual %}de <strong>{{ empresa_actual.nombre }}</strong>{% endif %}.
            {% if subempresa_actual %}
                Visualiza el balance general de {{ empresa_actual.nombre }} ({{ subempresa_actual.nombre }}).
            {% else %}
                Visualiza el balance general consolidado de todas las sub-empresas de {{ empresa_actual.nombre }}.
            {% endif %}
        </p>
    </div>
    <a href="#" class="btn" style="background-color: var(--color-text-dark); color: var(--color-white);">
        <i class="fas fa-file-pdf"></i> Exportar PDF
    </a>
</div>
{% endblock %}

{% block content %}
<div class="metric-grid">
    <div class="card" style="border-top: 4px solid var(--color-accent-green);">
        <h3>Total Activos</h3>
        <div class="value">
            ${{ total_activos|floatformat:2|intcomma }}
        </div>
    </div>
    <div class="card" style="border-top: 4px solid var(--color-danger-red);">
        <h3>Total Pasivos</h3>
        <div class="value">
            ${{ total_pasivos|floatformat:2|intcomma }}
        </div>
    </div>
    <div class="card" style="border-top: 4px solid var(--color-primary-blue);">
        <h3>Total Capital</h3>
        <div class="value">
            ${{ total_capital|floatformat:2|intcomma }}
        </div>
    </div>
</div>

<div class="card"
     style="min-height: 350px; margin-bottom: 40px; text-align: center; display: flex; align-items: center; justify-content: center;">
    <h3>Distribución por Sub-empresa</h3>

    {% if balance_detallado %}
        <canvas id="balanceChart" style="max-height: 380px;"></canvas>
    {% else %}
        <p style="text-align:center; color: var(--color-text-light); margin-top: 20px;">
            No hay datos suficientes para generar la gráfica.
        </p>
    {% endif %}
</div>

<div class="card">
    <h3>Balance General Detallado</h3>
    <div class="table-container">
        <table>
            <thead>
            <tr>
                <th>Sub-Empresa</th>
                <th>Activos ($)</th>
                <th>Pasivos ($)</th>
                <th>Capital ($)</th>
                <th>Ratio A/P</th>
            </tr>
            </thead>
            <tbody>
            {% if balance_detallado %}

                <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

                <script>
                    (function () {
                        const ctx = document.getElementById('balanceChart');
                        if (!ctx) return;

                        const labels = [
                            {% for row in balance_detallado %}
                                '{{ row.subempresa.nombre|escapejs }}'{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        ];

                        const dataActivos = [
                            {% for row in balance_detallado %}
                                {{ row.activos|default:0 }}{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        ];

                        const dataPasivos = [
                            {% for row in balance_detallado %}
                                {{ row.pasivos|default:0 }}{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        ];

                        const dataCapital = [
                            {% for row in balance_detallado %}
                                {{ row.capital|default:0 }}{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        ];

                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [
                                    {
                                        label: 'Activos',
                                        data: dataActivos,
                                    },
                                    {
                                        label: 'Pasivos',
                                        data: dataPasivos,
                                    },
                                    {
                                        label: 'Capital',
                                        data: dataCapital,
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                scales: {
                                    x: { stacked: false },
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            callback: function(value) {
                                                return '$' + value.toLocaleString();
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    })();
                </script>

                {% if total_activos or total_pasivos %}
                <div class="card" style="margin-top: 20px;">
                <h3>Resumen escrito del balance</h3>
                <p>
                    Para la empresa <strong>{{ empresa_actual.nombre }}</strong>
                    {% if subempresa_actual %} y la sub-empresa <strong>{{ subempresa_actual.nombre }}</strong>{% endif %}
                    se tienen activos por <strong>${{ total_activos|floatformat:2|intcomma }}</strong>,
                    pasivos por <strong>${{ total_pasivos|floatformat:2|intcomma }}</strong>
                    y un capital resultante de <strong>${{ total_capital|floatformat:2|intcomma }}</strong>.
                </p>
                
                </div>
                {% endif %}

                
                {% for fila in balance_detallado %}
                    <tr>
                        <td>{{ fila.subempresa.nombre }}</td>
                        <td>${{ fila.activos|floatformat:2|intcomma }}</td>
                        <td>${{ fila.pasivos|floatformat:2|intcomma }}</td>
                        <td>${{ fila.capital|floatformat:2|intcomma }}</td>
                        <td>
                            {% if fila.ratio_ap %}
                                {{ fila.ratio_ap|floatformat:2 }}
                            {% else %}
                                –
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                <tr style="font-weight: 600; background-color: #F3F4F6;">
                    <td>Total Consolidado</td>
                    <td style="color: var(--color-accent-green);">
                        ${{ total_activos|floatformat:2|intcomma }}
                    </td>
                    <td style="color: var(--color-danger-red);">
                        ${{ total_pasivos|floatformat:2|intcomma }}
                    </td>
                    <td style="color: var(--color-primary-blue);">
                        ${{ total_capital|floatformat:2|intcomma }}
                    </td>
                    <td>
                        {% if ratio_ap_total %}
                            {{ ratio_ap_total|floatformat:2 }}
                        {% else %}
                            –
                        {% endif %}
                    </td>
                </tr>
            {% else %}
                <tr>
                    <td colspan="5" style="text-align:center; color:var(--color-text-light);">
                        No hay información de balance disponible para el contexto seleccionado.
                    </td>
                </tr>
            {% endif %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
